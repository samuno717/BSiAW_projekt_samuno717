name: CI/CD Pipeline (L5 + L6)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  sast-and-quality:
    name: SAST & Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Download Code (Checkout)
        uses: actions/checkout@v3

      - name: Set Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Lib installation
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 bandit safety

      - name: Check code syntax
        run: |
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Security Audit - Dependencies
        run: |
          safety check -r requirements.txt --continue-on-error

      - name: Security Audit - Code
        run: |
          bandit -r . -f custom --msg-template "{abspath}:{line}: {test_id}[bandit]: {severity}: {msg}"

  dast-and-build:
    name: DAST & Docker Build
    needs: sast-and-quality
    runs-on: ubuntu-latest
    steps:
      - name: Download Code
        uses: actions/checkout@v3

      - name: Secrets handling test
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD_PROD }}
        run: |
          if [ -z "$DB_PASSWORD" ]; then
            echo "Warning: Secret DB_PASSWORD_PROD is not set on GitHub!"
            echo "In this demo the application will use the default password, but the secret mechanism is ready."
          else
            echo "Success! The secret has been successfully downloaded from GitHub."
          fi

      - name: Building and launching container (DAST)
        run: |
          docker build . --file Dockerfile --tag my-app:latest
          docker run -d -p 5000:5000 --name test-app my-app:latest
          sleep 10

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:5000'
          fail_action: false
          allow_issue_writing: false
